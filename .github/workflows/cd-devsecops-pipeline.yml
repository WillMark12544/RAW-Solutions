name: CD (Zip Deploy to Azure Web App - Windows)

on:
  workflow_run:
    workflows: ["CI DevSecOps Pipeline"]   # must match your CI workflow name
    types: [completed]
    branches: [master]                     # change to [main] if your repo uses main
  workflow_dispatch: {}                    # optional manual trigger

permissions:
  contents: read
  actions: read

jobs:
  deploy-zip:
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up .NET 8
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '8.0.x'          # change if your app targets a different version

      - name: Restore
        run: dotnet restore

      - name: Build & Publish (Release)
        run: dotnet publish NotesSampleApplication/NotesSampleApplication.csproj -c Release -o ./publish
        # ^ If your .csproj path is different, update this line.

      - name: Create deploy zip
        run: |
          cd publish
          zip -r ../app.zip .
          cd ..
          ls -lh app.zip

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Zip Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ secrets.AZURE_WEBAPP_NAME }}   # e.g., rawsolutions
          package: app.zip

      - name: Restart Web App
        run: |
          az webapp restart \
            --resource-group ${{ secrets.AZ_RG }} \
            --name ${{ secrets.AZURE_WEBAPP_NAME }}

      - name: Post-deploy health check
        run: |
          echo "üîç Checking ${{ secrets.PROD_URL }} ..."
          for i in {1..30}; do
            if curl -sf "${{ secrets.PROD_URL }}"; then
              echo "‚úÖ Site is live"
              exit 0
            fi
            echo "Waiting for app..."
            sleep 5
          done
          echo "‚ùå App did not respond in time" && exit 1
